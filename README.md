# dl-modeling

### Project structure

- micro-service : contains wrapper
- param : submmodule from repo param 
- archbench : submodule from repo archbench
- modelzoo: outward results folder, where all results and intermediate files will land
- speedsim: submodule from repo syssim/speedsim
- results: contains results generated by arch bench
- test : set of regression tests

### Setup

- prerequisite
    - conda 4.8.2
    - python 3.7

- create conda environment
```
/dl-modeling >>> conda env create -f environment.yml
```
- activate conda environment
```
/dl-modeling >>> conda activate dlmodel
```

- for windows, install caffe using below commands

```
(dlmodel) /dl-modeling >>> conda config --add channels anaconda
(dlmodel) /dl-modeling >>> conda install caffe -c willyd
```

### How to run

micro_service/dl-modelling.py is the integrating script to execute Archbench, Param and Speed sim

```
python ./micro_service/dl-modelling.py summary -pc ./modelzoo/base_param_cfg.yml -po ./modelzoo/Report.csv -g ./ab-release-automation/ConfigSpecs/Gen12-SKUs-PVC.xlsx -w ./ab-release-automation/WorkloadSpecs/PVC-Workloads.xlsx -i FALSE -t TRUE --compderate 0.95 --fusion workload --pipeline-backward-pass TRUE --flush-oversized-output-tensor TRUE -o outdump -s AGGR -a run --filtersku PVC1T-512-C0 --filter RESNET-50-MLPerf-BF16 
```

arguments:
  - -h, --help            show this help message and exit
  - -f WORKLOAD_GRAPH, --workload_graph WORKLOAD_GRAPH
  - -cf ARCHBENCH_CONFIG, --archbench_config ARCHBENCH_CONFIG
  - -c CONFIGFILE, --configfile CONFIGFILE
  - -o OUTPUTFILE, --outputfile OUTPUTFILE
  - -so, --scaleout
  - -so_config SCALEOUT_CONFIG, --scaleout_config SCALEOUT_CONFIG
  - -training, --training
  - -ssd, --ss_detailed_report


usgae:

- Support for sub commands `summary` , `sweep` , `param`, `ubench`, `archbench`, `upload_config` and `upload_result` 

- sample run using resnet 50 network
```
(dlmodel) /dl-modeling >>> python ./micro_service/dl-modelling.py summary -f ./archbench/networks/ResNet-50.prototxt -cf ./archbench/configs/gen12-pvc.yaml -c ./modelzoo/base_param_cfg.yml -o ./modelzoo/Report.csv  --dump_html -ssd
```

- sample run using bert network with scale out
```
(dlmodel) /dl-modeling >>> python ./micro_service/dl-modelling.py summary -f ./archbench/networks/BERT_enc_s512_lay24_c13_h16.py -cf ./archbench/configs/gen12-pvc.yaml -c ./modelzoo/base_param_cfg.yml -o ./modelzoo/Report.csv  --dump_html -ssd
```

- by default use of buffers is disabled, to enanble buffers set `use_buffer` found in `config.csv` to `1`

- default results location `"./modelzoo/"`, can be changed by editing `config.csv` outFilePath parameter to desired location

- `'sweep' ` subcommand supports sweep either one or two config parameters
- sample sweep run with one parameter, sweeping frequency from 1.0 GHz to 1.5 GHz
```
(dlmodel) /dl-modeling >>> python ./micro_service/dl-modelling.py sweep -sp1 frequency_in_Ghz -sr1 1.0,1.5,0.1 -f ./archbench/networks/ResNet-50.prototxt -cf ./archbench/configs/gen12-pvc.yaml -c ./modelzoo/base_param_cfg.yml -o ./modelzoo/Report.csv  --dump_html -ssd
```

- sample sweep run with two parameter, sweeping frequency from 1.0 GHz to 1.5 GHz and num_Nics from 8 to 512, in powers of 2
```
(dlmodel) /dl-modeling >>> python ./micro_service/dl-modelling.py sweep -sp1 frequency_in_Ghz -sr1 1.0,1.5,0.1 -sp2 num_Nics -sr2 8,512,pow2 -f ./archbench/networks/ResNet-50.prototxt -cf ./archbench/configs/gen12-pvc.yaml -c ./modelzoo/base_param_cfg.yml -o ./modelzoo/Report.csv  --dump_html -ssd
```

- sample param run `(note param run depends on results from archbench, hence there should be atleast one run of archbench before param is executed)`
```
(dlmodel) /dl-modeling >>> python ./micro_service/dl-modelling.py param -f ./archbench/networks/ResNet-50.prototxt -cf ./archbench/configs/gen12-pvc.yaml -c ./modelzoo/base_param_cfg.yml -o ./modelzoo/Report.csv  --dump_html -ssd
```
- `ubench` command supports running and getting comm time for one message size (no compute model)
- sample ubench run
```
python ./micro_service/dl-modelling.py ubench -m 640M -c modelzoo\base_param_cfg.yml
```

- sample archbench run
```
python ./micro_service/dl-modelling.py archbench -f ./archbench/networks/ResNet-50.prototxt -cf ./archbench/configs/gen12-pvc.yaml --dump_html
```

- sample config upload run

```
(dlmodel) /dl-modeling >>> python ./micro_service/dl-modelling.py upload_config --workload Bert --cards 16 --tiles_per_card 2 --cfg_type Scaleout --cfg_file ./modelzoo/config_scaleout.csv --product_line PVC
```

- sample results upload run

```
(dlmodel) /dl-modeling >>> python ./micro_service/dl-modelling.py upload_result --workload Bert --cards 16 --tiles_per_card 2 --result_type Archbench --result_file ./modelzoo/ResNet-50.prototxt_stats_200.0MB_CMX_FSPS.csv --product_line PV
```



